syntax = "proto3";

package bus_system;

// --- Services ---

// 1. Booking Service (Unary)
service BookingService {
  rpc CreateBooking (BookingRequest) returns (BookingResponse);
  rpc GetBookingStatus (BookingIdRequest) returns (BookingStatusResponse);
}

// 2. Chat Service (Bidirectional Streaming)
service ChatService {
  rpc JoinChat (UserIdentity) returns (stream ChatEvent); // Unified downstream
  rpc SendMessage (stream ChatClientMessage) returns (Ack);       // Unified upstream
  rpc StreamChatUpdates (Empty) returns (stream ChatEvent); // For Admin Dashboard List
}

// ...

message ChatClientMessage {
  oneof payload {
      ChatMessage message = 1;
      TypingIndicator typing = 2;
      ReadReceipt read = 3;
  }
}

// 3. Seat Sync Service (Server Streaming)
service SeatSyncService {
  rpc WatchSeatAvailability (RouteRequest) returns (stream SeatUpdate);
}

// --- Messages ---

message Empty {}

message Ack {
  bool success = 1;
  string message = 2;
}

message UserIdentity {
  string user_id = 1; // "admin" or valid user ID
  string role = 2;
}

message ChatMessage {
  string id = 1;
  string sender_id = 2;
  string sender_name = 3;
  string receiver_id = 4; // "admin" or user ID
  string content = 5;
  string timestamp = 6;
  bool is_admin = 7;
}

message TypingIndicator {
  string user_id = 1;
  string user_name = 2;
  bool is_typing = 3;
}

message ReadReceipt {
  string message_id = 1;
  string reader_id = 2; // "admin" or user ID
  string timestamp = 3;
}

message ChatEvent {
  string type = 1; // "new_message", "user_online", "typing", "read"
  oneof payload {
    ChatMessage message = 2;
    TypingIndicator typing = 3;
    ReadReceipt read = 4;
  }
}

message BookingRequest {
  string user_id = 1;
  string armada_id = 2;
  string schedule_id = 3;
  string date = 4;
  repeated string seats = 5; // ["1A", "1B"]
  int32 total_price = 6;
}

message BookingResponse {
  bool success = 1;
  string booking_id = 2;
  string error_message = 3;
}

message BookingIdRequest {
  string booking_id = 1;
}

message BookingStatusResponse {
  string status = 1; // "confirmed", "pending"
  bool checked_in = 2;
}

message RouteRequest {
  string route_id = 1;
  string date = 2;
}

message SeatUpdate {
  string armada_id = 1;
  repeated string booked_seats = 2; // Full list of currently booked seats
}
